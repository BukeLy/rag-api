# ============================================================
# RAG API 配置文件
# ============================================================
# 使用说明：
# 1. 复制此文件为 .env：cp env.example .env
# 2. 填入真实的 API 密钥
# 3. 根据需要调整可选配置
# ============================================================
#
# 🚀 部署环境配置
# 当前配置针对：EC2 持久化容器环境
#
# 关键配置差异：
# - MAX_ASYNC=8（EC2推荐值，充分利用持久化HTTP连接）
# - Worker预热：启用（src/rag.py中实现，减少首次查询延迟）
# - 文件服务：配置为公网IP（支持remote MinerU）
#
# 其他部署环境调整建议：
# - Fargate自动扩缩：MAX_ASYNC=4（减少冷启动时间）
# - Lambda：不推荐（Worker机制不适合Serverless）
#
# ============================================================

# ====== LLM 配置（豆包/火山引擎） ======
# 用于文本生成、实体提取、关系提取等
ARK_API_KEY=your_ark_api_key_here
ARK_BASE_URL=https://ark.ap-southeast.bytepluses.com/api/v3
# 使用的模型名称
ARK_MODEL=seed-1-6-250615

# ====== Embedding 配置（硅基流动） ======
# 用于向量化文本，支持语义检索
SF_API_KEY=your_sf_api_key_here
SF_BASE_URL=https://api.siliconflow.cn/v1
# 使用的 Embedding 模型（4096 维向量）
SF_EMBEDDING_MODEL=Qwen/Qwen3-Embedding-8B

# ====== Rerank 配置（重排序模型） ======
# 用于提升检索结果的相关性（可选但推荐）
# 使用硅基流动的 Rerank API（复用上面的 SF_API_KEY）
# 推荐模型：Qwen/Qwen3-Reranker-8B
# 留空则禁用 rerank 功能
RERANK_MODEL=Qwen/Qwen3-Reranker-8B

# ====== MinerU 配置 ======

# --- MinerU 运行模式 ---
# 选项：
#   local  - 本地运行 MinerU（需要 GPU、大内存）
#   remote - 使用远程 MinerU API（推荐，节省资源）⭐
# 
# 注意：远程模式的性能优化
#   ✅ 并发控制：remote 模式允许高并发（10+），local 模式限制为 1
#   ⏳ 批量处理：未来将支持批量文档识别（充分利用 API 性能）
#   ⏳ 文件URL：当前需要实现文件上传到临时存储服务
MINERU_MODE=local

# --- 远程 MinerU API 配置 ---
# 官方文档：https://mineru.net/apiManage/docs
# 注册地址：https://mineru.net（免费账号每天 2000 页额度）
# 优势：无需 GPU、无需下载模型、降低本地资源消耗
# 注意：只需要一个 Token（在官网申请）
MINERU_API_TOKEN=your_mineru_api_token_here
MINERU_API_BASE_URL=https://mineru.net

# --- MinerU 模型版本配置 ---
# pipeline: 传统管道架构，成熟稳定
# vlm: 统一多模态模型，准确度更高且速度更快（< 1B 参数，超越 72B VLM）⭐推荐
MINERU_MODEL_VERSION=vlm

# --- 远程 MinerU 限流配置 ---
# 根据您的 API 套餐调整
MINERU_MAX_CONCURRENT_REQUESTS=5     # 最大并发请求数
MINERU_REQUESTS_PER_MINUTE=60        # 每分钟最大请求数
MINERU_RETRY_MAX_ATTEMPTS=3          # 失败重试次数
MINERU_POLL_TIMEOUT=600              # 任务轮询超时（秒）

# ====== 文件服务配置（远程 MinerU 必需） ======
# 文件服务基础 URL（必须设置为服务器公网 IP:8000）
# ⚠️  重要：使用 remote MinerU 时，必须配置为公网可访问的 URL
# 本地开发：http://localhost:8000
# 生产环境：http://45.78.223.205:8000 或你的服务器 IP
FILE_SERVICE_BASE_URL=http://45.78.223.205:8000

# 文件清理配置（小时）
FILE_CLEANUP_HOURS=24

# 文件清理间隔（秒），默认 3600 秒（1 小时）
FILE_CLEANUP_INTERVAL=3600

# ====== 系统配置 ======

# --- 日志配置 ---
# 日志级别：DEBUG（开发环境）/ INFO（生产环境推荐）/ WARNING / ERROR / CRITICAL
LOG_LEVEL=INFO

# 日志保留天数（自动清理旧日志）
LOG_RETENTION_DAYS=30

# --- 文件上传限制 ---
MAX_UPLOAD_SIZE=104857600  # 100MB (字节)

# --- 工作目录 ---
WORKING_DIR=./rag_local_storage

# --- 文档处理并发控制 ---
# 限制同时处理的文档数量，防止 OOM
# 注意：远程模式可大幅提升并发数（10+），本地模式建议保持为 1
DOCUMENT_PROCESSING_CONCURRENCY=1

# ====== LightRAG 查询优化参数 ======
# 用于控制查询性能和质量的平衡

# --- 检索参数 ---
# top_k: 检索的实体/关系数量（默认 60，推荐 20-40）
# 数值越大，检索越全面但速度越慢
TOP_K=20

# chunk_top_k: 检索的文本块数量（默认 20，推荐 10-20）
CHUNK_TOP_K=10

# --- Token 限制 ---
# 控制 LLM 调用时的上下文大小
MAX_ENTITY_TOKENS=6000      # 实体上下文最大 token 数
MAX_RELATION_TOKENS=8000    # 关系上下文最大 token 数
MAX_TOTAL_TOKENS=30000      # 总 token 数限制

# --- 并发配置（针对 EC2 持久化容器优化）---
# LightRAG 内部并发参数
# EC2/ECS 持久化环境推荐：MAX_ASYNC=8（充分利用持久化连接）
# Fargate 自动扩缩环境：MAX_ASYNC=4（减少冷启动时间）
MAX_ASYNC=8                 # LLM 最大并发请求数（EC2环境推荐值）
MAX_PARALLEL_INSERT=2       # 文档插入最大并发数

# 文档处理并发数（动态配置，根据 MINERU_MODE 自动调整）
# - local 模式：默认 1（防止本地 OOM）
# - remote 模式：默认 10（充分利用远程 API）
# 留空则使用自动配置
# DOCUMENT_PROCESSING_CONCURRENCY=10

# --- 元数据管理配置（v1.4.9.4 新增） ---
# 用于优化大规模知识图谱的性能
# 限制每个实体/关系的源文档ID数量，防止元数据膨胀导致的性能下降
MAX_SOURCE_IDS_PER_ENTITY=300      # 每个实体最大源文档ID数（默认300）
MAX_SOURCE_IDS_PER_RELATION=300    # 每个关系最大源文档ID数（默认300）
SOURCE_IDS_LIMIT_METHOD=FIFO       # 限制策略：FIFO（先进先出，推荐）或 KEEP（保留现有）
MAX_FILE_PATHS=100                 # 最大文件路径数（默认100）

# ====== 可选配置 ======

# --- 时区 ---
TZ=Asia/Shanghai

# --- Python 配置 ---
PYTHONUNBUFFERED=1  # 禁用输出缓冲，实时查看日志

