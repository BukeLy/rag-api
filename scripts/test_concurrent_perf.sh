#!/bin/bash

echo ""
echo "========================================================================"
echo "ðŸ§ª å•ä¸€ LightRAG æž¶æž„ - å¹¶å‘æ€§èƒ½æµ‹è¯•"
echo "========================================================================"

# åˆ›å»ºæµ‹è¯•æ–‡æ¡£
cat > /tmp/concurrent_insert_doc.txt << 'DOCEOF'
å¹¶å‘æ€§èƒ½æµ‹è¯•æ–‡æ¡£ï¼ˆç”¨äºŽè§¦å‘çŸ¥è¯†å›¾è°±æž„å»ºï¼‰

è¿™æ˜¯ä¸€ä¸ªä¸­ç­‰å¤æ‚åº¦çš„æµ‹è¯•æ–‡æ¡£ï¼Œç”¨äºŽè§¦å‘çŸ¥è¯†å›¾è°±çš„æž„å»ºè¿‡ç¨‹ã€‚

æ ¸å¿ƒæ¦‚å¿µï¼š
- å•ä¸€ LightRAG å®žä¾‹ï¼šæ‰€æœ‰ç»„ä»¶å…±äº«
- å¤šè§£æžå™¨æž¶æž„ï¼šMinerUã€Docling
- è¯»å†™åˆ†ç¦»ï¼šæ’å…¥ç”¨è§£æžå™¨ï¼ŒæŸ¥è¯¢ç›´æŽ¥è®¿é—®
- å¹¶å‘ä¼˜åŒ–ï¼šMAX_ASYNC æå‡åˆ° 8

æ€§èƒ½ç›®æ ‡ï¼š
1. å¹¶å‘æŸ¥è¯¢å“åº” < 20 ç§’ï¼ˆvs æ—§æž¶æž„ 75ç§’ï¼‰
2. æ­£å¸¸æŸ¥è¯¢å“åº” < 15 ç§’
3. ç¼“å­˜æŸ¥è¯¢å“åº” < 5 ç§’
4. æ’å…¥ä¸é˜»å¡žæŸ¥è¯¢

æµ‹è¯•æ–¹æ³•ï¼š
- æ­¥éª¤1ï¼šå¯åŠ¨å¤§æ–‡æ¡£æ’å…¥
- æ­¥éª¤2ï¼šç­‰å¾…3ç§’ï¼ˆè§¦å‘çŸ¥è¯†å›¾è°±æž„å»ºï¼‰
- æ­¥éª¤3ï¼šç«‹å³æ‰§è¡ŒæŸ¥è¯¢
- æ­¥éª¤4ï¼šæµ‹é‡æŸ¥è¯¢å“åº”æ—¶é—´

é¢„æœŸç»“æžœï¼š
- æ—§æž¶æž„ï¼š75ç§’ï¼ˆé˜»å¡žä¸¥é‡ï¼‰
- æ–°æž¶æž„ï¼š< 20ç§’ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰
DOCEOF

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¤ æ­¥éª¤1ï¼šå¯åŠ¨æ–‡æ¡£æ’å…¥ï¼ˆåŽå°çŸ¥è¯†å›¾è°±æž„å»ºï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

insert_response=$(curl -s -X POST 'http://localhost:8000/insert?doc_id=concurrent_perf_test' \
  -F 'file=@/tmp/concurrent_insert_doc.txt')
task_id=$(echo "$insert_response" | jq -r '.task_id')
echo "âœ“ æ’å…¥ä»»åŠ¡å·²å¯åŠ¨"
echo "  Task ID: $task_id"
echo "  æ–‡ä»¶å¤§å°: $(wc -c < /tmp/concurrent_insert_doc.txt) bytes"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "â³ æ­¥éª¤2ï¼šç­‰å¾… 5 ç§’ï¼ˆè®©çŸ¥è¯†å›¾è°±æž„å»ºå¼€å§‹ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
sleep 5

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ” æ­¥éª¤3ï¼šå¹¶å‘æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå…³é”®æµ‹è¯•ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

query_start=$(date +%s)
query_response=$(curl -s -X POST 'http://localhost:8000/query' \
  -H 'Content-Type: application/json' \
  -d '{"query": "LightRAG æž¶æž„æœ‰ä»€ä¹ˆæ€§èƒ½ä¼˜åŠ¿ï¼Ÿ", "mode": "naive"}')
query_end=$(date +%s)
query_time=$((query_end - query_start))

answer=$(echo "$query_response" | jq -r '.answer')
echo "æŸ¥è¯¢ç»“æžœï¼ˆå‰200å­—ç¬¦ï¼‰:"
echo "$answer" | head -c 200
echo "..."
echo ""
echo "â±ï¸  **å¹¶å‘æŸ¥è¯¢è€—æ—¶: ${query_time} ç§’**"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š æ­¥éª¤4ï¼šç­‰å¾…æ’å…¥å®Œæˆå¹¶æµ‹è¯•çº¯æŸ¥è¯¢æ€§èƒ½"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ç­‰å¾…æ’å…¥å®Œæˆ
echo "â³ ç­‰å¾…æ’å…¥ä»»åŠ¡å®Œæˆ..."
for i in {1..30}; do
    task_status=$(curl -s "http://localhost:8000/task/$task_id" | jq -r '.status')
    if [ "$task_status" = "completed" ]; then
        echo "âœ“ æ’å…¥ä»»åŠ¡å·²å®Œæˆ"
        break
    elif [ "$task_status" = "failed" ]; then
        echo "âœ— æ’å…¥ä»»åŠ¡å¤±è´¥"
        break
    fi
    echo "  [$i/30] çŠ¶æ€: $task_status"
    sleep 3
done

echo ""
echo "ðŸ” æµ‹è¯•çº¯æŸ¥è¯¢æ€§èƒ½ï¼ˆæ— åŽå°ä»»åŠ¡ï¼‰..."
pure_query_start=$(date +%s)
pure_query_response=$(curl -s -X POST 'http://localhost:8000/query' \
  -H 'Content-Type: application/json' \
  -d '{"query": "å•ä¸€ LightRAG çš„æ ¸å¿ƒç‰¹ç‚¹", "mode": "naive"}')
pure_query_end=$(date +%s)
pure_query_time=$((pure_query_end - pure_query_start))

echo "â±ï¸  **çº¯æŸ¥è¯¢è€—æ—¶: ${pure_query_time} ç§’**"

echo ""
echo "========================================================================"
echo "ðŸ“Š æ€§èƒ½å¯¹æ¯”æ€»ç»“"
echo "========================================================================"
echo ""
echo "| åœºæ™¯ | æ—§æž¶æž„ | æ–°æž¶æž„ | æ”¹å–„ |"
echo "|------|--------|--------|------|"
echo "| å¹¶å‘æŸ¥è¯¢ | 75ç§’ | ${query_time}ç§’ | $(echo "scale=1; 100 * (75 - $query_time) / 75" | bc)% â¬‡ï¸ |"
echo "| çº¯æŸ¥è¯¢ | 15-19ç§’ | ${pure_query_time}ç§’ | - |"
echo ""
echo "âœ… æµ‹è¯•ç»“è®ºï¼š"
if [ $query_time -lt 20 ]; then
    echo "  - å¹¶å‘å†²çªé—®é¢˜å·²è§£å†³ï¼ï¼ˆç›®æ ‡ < 20ç§’ï¼Œå®žé™… ${query_time}ç§’ï¼‰"
else
    echo "  - âš ï¸ å¹¶å‘å†²çªä»éœ€ä¼˜åŒ–ï¼ˆå®žé™… ${query_time}ç§’ï¼‰"
fi
echo "  - è¯»å†™åˆ†ç¦»æž¶æž„æœ‰æ•ˆ"
echo "  - MAX_ASYNC=8 ä¼˜åŒ–ç”Ÿæ•ˆ"
