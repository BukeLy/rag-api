name: CI - Basic Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync

      - name: Check code formatting
        run: |
          uv run ruff format --check . || echo "âš ï¸  Code formatting issues found (not blocking CI)"

      - name: Lint with ruff
        run: |
          echo "ğŸ“Š Running ruff lint check..."
          uv run ruff check . --statistics || echo "âš ï¸  Linting issues found (not blocking CI)"
          echo "âœ… Lint check completed (informational only)"

  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check environment example completeness
        run: |
          echo "ğŸ” Validating env.example..."

          # å¿…é¡»å­˜åœ¨çš„é…ç½®é¡¹
          required_vars=(
            "LLM_API_KEY"
            "LLM_BASE_URL"
            "LLM_MODEL"
            "EMBEDDING_API_KEY"
            "EMBEDDING_BASE_URL"
            "EMBEDDING_MODEL"
            "EMBEDDING_DIM"
            "MINERU_MODE"
            "MINERU_API_TOKEN"
            "TASK_STORE_STORAGE"
            "TENANT_CONFIG_STORAGE"
          )

          missing_vars=()
          for var in "${required_vars[@]}"; do
            if ! grep -q "^$var=" env.example; then
              missing_vars+=("$var")
            fi
          done

          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "âŒ Missing required variables in env.example:"
            printf '%s\n' "${missing_vars[@]}"
            exit 1
          fi

          echo "âœ… env.example contains all required variables"

      - name: Validate TASK_STORE_STORAGE documentation
        run: |
          echo "ğŸ” Checking TASK_STORE_STORAGE documentation..."

          # éªŒè¯ env.example ä¸­å˜é‡å®šä¹‰ä¹‹å‰æ˜¯å¦æœ‰æ­£ç¡®çš„æ³¨é‡Šè¯´æ˜
          # ä½¿ç”¨ -B 7 æŸ¥æ‰¾å˜é‡å®šä¹‰ä¹‹å‰çš„ 7 è¡Œï¼ˆè¦†ç›–æ‰€æœ‰æ–‡æ¡£æ³¨é‡Šï¼‰
          # æ£€æŸ¥æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å« memory å’Œ redis ä¸¤ç§å­˜å‚¨æ–¹å¼çš„è¯´æ˜
          doc_content=$(grep -B 7 "^TASK_STORE_STORAGE=" env.example)

          if ! echo "$doc_content" | grep -q "memory"; then
            echo "âŒ TASK_STORE_STORAGE documentation missing 'memory' option"
            exit 1
          fi

          if ! echo "$doc_content" | grep -q "redis"; then
            echo "âŒ TASK_STORE_STORAGE documentation missing 'redis' option"
            exit 1
          fi

          echo "âœ… TASK_STORE_STORAGE documented correctly (both memory and redis options)"

      - name: Check Docker Compose syntax
        run: |
          echo "ğŸ” Validating Docker Compose files..."

          # éªŒè¯å¼€å‘ç¯å¢ƒé…ç½®
          docker compose -f docker-compose.dev.yml config > /dev/null
          echo "âœ… docker-compose.dev.yml is valid"

          # éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®
          docker compose -f docker-compose.yml config > /dev/null
          echo "âœ… docker-compose.yml is valid"

      - name: Check TASK_STORE_STORAGE in docker-compose
        run: |
          echo "ğŸ” Checking TASK_STORE_STORAGE in Docker Compose..."

          # éªŒè¯å¼€å‘ç¯å¢ƒåŒ…å« TASK_STORE_STORAGE
          if ! grep -q "TASK_STORE_STORAGE" docker-compose.dev.yml; then
            echo "âŒ TASK_STORE_STORAGE missing in docker-compose.dev.yml"
            exit 1
          fi

          # éªŒè¯ç”Ÿäº§ç¯å¢ƒåŒ…å« TASK_STORE_STORAGE
          if ! grep -q "TASK_STORE_STORAGE" docker-compose.yml; then
            echo "âŒ TASK_STORE_STORAGE missing in docker-compose.yml"
            exit 1
          fi

          echo "âœ… TASK_STORE_STORAGE configured in both docker-compose files"

      - name: Deployment pre-check simulation
        run: |
          echo "ğŸ” Simulating deployment pre-check..."

          # åˆ›å»ºæ¨¡æ‹Ÿ .env æ–‡ä»¶
          cp env.example .env

          # å¡«å……å¿…è¦çš„æµ‹è¯•å€¼
          sed -i 's/your_mineru_api_token_here/test_token_12345/g' .env
          sed -i 's/your_llm_api_key_here/test_key_12345/g' .env
          sed -i 's/your_embedding_api_key_here/test_key_12345/g' .env
          sed -i 's/your_rerank_api_key_here/test_key_12345/g' .env
          sed -i 's/your_deepseek_ocr_api_key_here/test_key_12345/g' .env

          # ç¡®ä¿ MINERU_MODE ä¸º remote
          sed -i 's/^MINERU_MODE=.*/MINERU_MODE=remote/' .env

          echo "âœ… Environment simulation created"

          # è¿è¡Œéƒ¨ç½²æ£€æŸ¥è„šæœ¬ï¼ˆè·³è¿‡ç½‘ç»œè¿é€šæ€§æµ‹è¯•ï¼‰
          echo "ğŸ“‹ Would run: bash scripts/check-deployment.sh"
          echo "âš ï¸  Skipping network connectivity test in CI"

  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Check shell scripts
        run: |
          echo "ğŸ” Running shellcheck on all .sh files..."

          # æŸ¥æ‰¾æ‰€æœ‰ .sh æ–‡ä»¶
          shfiles=$(find . -name "*.sh" -not -path "./.git/*" -not -path "./.venv/*")

          if [ -z "$shfiles" ]; then
            echo "âš ï¸  No shell scripts found"
            exit 0
          fi

          failed=0
          for file in $shfiles; do
            echo "Checking $file..."
            if ! shellcheck -x "$file"; then
              failed=1
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "âŒ Some shell scripts have issues"
            exit 1
          fi

          echo "âœ… All shell scripts passed shellcheck"
