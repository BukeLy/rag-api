# 开发环境 Docker Compose
# 架构: DragonflyDB + Qdrant + Memgraph（新存储架构）
# 特性：代码外挂、热重载、快速迭代

services:
  # ==================== RAG API ====================
  rag-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # ===代码热重载（Dev环境特色）===
      # 修改代码立即生效，无需重新构建镜像
      - ./src:/app/src
      - ./api:/app/api
      - ./main.py:/app/main.py
      # ===数据目录挂载===
      - ./rag_local_storage:/app/rag_local_storage
      - ./output:/app/output
      - ./logs:/app/logs
      - ./model_cache:/root/.cache
      - rag_files:/tmp/rag-files  # 持久化临时文件（用于 MinerU remote）
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - UV_HTTP_TIMEOUT=60
      # ⚠️ 新存储架构配置（✅ 从 .env 读取）
      - USE_EXTERNAL_STORAGE=${USE_EXTERNAL_STORAGE:-true}
      - KV_STORAGE=${KV_STORAGE:-RedisKVStorage}
      - VECTOR_STORAGE=${VECTOR_STORAGE:-QdrantStorage}
      - GRAPH_STORAGE=${GRAPH_STORAGE:-MemgraphStorage}
      # VLM 增强配置（✅ 从 .env 读取）
      - RAG_VLM_MODE=${RAG_VLM_MODE:-off}
      - RAG_IMPORTANCE_THRESHOLD=${RAG_IMPORTANCE_THRESHOLD:-0.5}
      - RAG_CONTEXT_WINDOW=${RAG_CONTEXT_WINDOW:-2}
      - RAG_CONTEXT_MODE=${RAG_CONTEXT_MODE:-page}
      - RAG_MAX_CONTEXT_TOKENS=${RAG_MAX_CONTEXT_TOKENS:-3000}
      # DragonflyDB 配置（✅ 从 .env 读取）
      - REDIS_URI=${REDIS_URI:-redis://dragonflydb:6379/0}
      # Qdrant 配置（✅ 从 .env 读取）
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      # Memgraph 配置（✅ 从 .env 读取）
      - MEMGRAPH_URI=${MEMGRAPH_URI:-bolt://memgraph:7687}
      # Embedding 维度（✅ 从 .env 读取）
      - EMBEDDING_DIM=${EMBEDDING_DIM:-1024}
    depends_on:
      dragonflydb:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      memgraph:
        condition: service_healthy
    networks:
      - rag-network
    # 热重载命令
    command: ["uv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== DragonflyDB（KV 存储）====================
  dragonflydb:
    image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
    container_name: rag-dragonflydb
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - dragonflydb_data:/data
    command: >
      dragonfly
      --dir=/data
      --snapshot_cron="0 */6 * * *"
      --maxmemory=2048mb
      --keys_output_limit=1024
      --dbfilename=dump
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rag-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== Qdrant（向量存储）====================
  qdrant:
    build:
      context: .
      dockerfile: Dockerfile.qdrant
    image: rag-qdrant:latest
    container_name: rag-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      # 性能优化配置
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      # 日志级别
      - QDRANT__LOG_LEVEL=INFO
      # 持久化配置
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - rag-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== Memgraph（图存储）====================
  memgraph:
    image: memgraph/memgraph-platform:latest
    container_name: rag-memgraph
    restart: unless-stopped
    ports:
      - "7687:7687"  # Bolt
      - "7444:7444"  # Memgraph Lab UI
    volumes:
      - memgraph_data:/var/lib/memgraph
      # 注意：移除日志 volume 以避免权限问题，使用 docker logs 查看日志
    healthcheck:
      test: ["CMD-SHELL", "echo 'RETURN 1;' | mgconsole --host 127.0.0.1 --port 7687 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - rag-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== LightRAG WebUI（可视化）====================
  lightrag-webui:
    image: ghcr.io/hkuds/lightrag:latest
    container_name: lightrag-webui
    restart: unless-stopped
    ports:
      - "9621:9621"
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      # ⚠️ WebUI 也要切换到新存储
      - USE_EXTERNAL_STORAGE=true
      - KV_STORAGE=RedisKVStorage
      - VECTOR_STORAGE=QdrantStorage
      - GRAPH_STORAGE=MemgraphStorage
      # DragonflyDB 配置
      - REDIS_URI=redis://dragonflydb:6379/0
      # Qdrant 配置
      - QDRANT_URL=http://qdrant:6333
      # Memgraph 配置
      - MEMGRAPH_URI=bolt://memgraph:7687
      - MEMGRAPH_USERNAME=
      - MEMGRAPH_PASSWORD=
      # LLM 绑定配置（使用新的功能导向命名）
      - LLM_BINDING=openai
      - LLM_BINDING_API_KEY=${LLM_API_KEY}
      - LLM_BINDING_HOST=${LLM_BASE_URL}
      - LLM_MODEL=${LLM_MODEL:-seed-1-6-250615}
      # Embedding 绑定配置（使用新的功能导向命名）
      - EMBEDDING_BINDING=openai
      - EMBEDDING_BINDING_API_KEY=${EMBEDDING_API_KEY}
      - EMBEDDING_BINDING_HOST=${EMBEDDING_BASE_URL}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-0.6B}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-1024}
      # Workspace 配置
      - LIGHTRAG_WEBUI_WORKSPACE=${LIGHTRAG_WEBUI_WORKSPACE:-default}
      # ⚠️ 性能和超时优化（解决 LLM 超时问题）
      - MAX_ASYNC=${MAX_ASYNC:-16}           # LLM 并发请求数（默认 4 → 16）
      - LLM_TIMEOUT=${LLM_TIMEOUT:-900}      # LLM 超时时间秒（默认 360 → 900）
      - TOP_K=${TOP_K:-20}                   # 实体检索数量
      - CHUNK_TOP_K=${CHUNK_TOP_K:-10}       # 文本块检索数量
    depends_on:
      dragonflydb:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      memgraph:
        condition: service_healthy
    networks:
      - rag-network
    command:
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "9621"
      - "--working-dir"
      - "/app/lightrag_working_dir"
      - "--llm-binding"
      - "openai"
      - "--embedding-binding"
      - "openai"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  rag-network:
    driver: bridge

volumes:
  dragonflydb_data:
    driver: local
  qdrant_data:
    driver: local
  memgraph_data:
    driver: local
  rag_files:
    driver: local
